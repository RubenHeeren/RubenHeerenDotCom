<section
  id="giscuss-container"
  class="mx-auto px-0 mt-12"
></section>

<script is:inline>
  const GISCUS_ORIGIN = "https://giscus.app";

  const GISCUS_CONFIG = {
    src: "https://giscus.app/client.js",
    "data-repo": "RubenHeeren/RubenHeerenDotCom",
    "data-repo-id": "R_kgDOQc9Edw",
    "data-category": "Blog Posts Comments",
    "data-category-id": "DIC_kwDOQc9Ed84CzHVQ",
    "data-mapping": "url",
    "data-strict": "0",
    "data-reactions-enabled": "1",
    "data-emit-metadata": "1",
    "data-input-position": "top",
    "data-theme": "preferred_color_scheme",
    "data-lang": "en",
    "data-loading": "lazy",
    crossorigin: "anonymous",
    async: "true",
  };

  let themeObserverStarted = false;
  let messageListenerStarted = false;

  function initGiscus() {
    const container = document.querySelector("#giscuss-container");
    if (!container) return;

    // If iframe already exists, Giscus is initialized
    if (container.querySelector("iframe.giscus-frame")) return;

    const script = document.createElement("script");
    Object.entries(GISCUS_CONFIG).forEach(([key, value]) => {
      script.setAttribute(key, value);
    });

    container.innerHTML = "";
    container.appendChild(script);
  }

  function getCurrentTheme() {
    return document.documentElement.getAttribute("data-theme") === "dark"
      ? "dark"
      : "light";
  }

  function postThemeToGiscus() {
    const iframe = document.querySelector("iframe.giscus-frame");
    if (!iframe?.contentWindow) return;

    iframe.contentWindow.postMessage(
      { giscus: { setConfig: { theme: getCurrentTheme() } } },
      GISCUS_ORIGIN
    );
  }

  function setupThemeObserverOnce() {
    if (themeObserverStarted) return;
    themeObserverStarted = true;

    const observer = new MutationObserver(() => {
      initGiscus();
      setTimeout(postThemeToGiscus, 200);
    });

    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ["data-theme"],
    });
  }

  function setupMessageListenerOnce() {
    if (messageListenerStarted) return;
    messageListenerStarted = true;

    window.addEventListener("message", (event) => {
      if (event.origin !== GISCUS_ORIGIN) return;
      if (!event.data || typeof event.data !== "object") return;
      if (!("giscus" in event.data)) return;

      postThemeToGiscus();
    });
  }

  document.addEventListener("astro:page-load", () => {
    initGiscus();
    setupThemeObserverOnce();
    setupMessageListenerOnce();
    setTimeout(postThemeToGiscus, 200);
  });
</script>